<section>
  <!-- CHANNEL VIEW -->
  <ng-container
    *ngIf="
      viewMode === 'channel' &&
      currentChannel as activeChannel;
      else notChannelView
    "
  >
    <header class="dm-header">
      <div class="channel-header-left">
        <h2 class="fw-700 fs-24"># {{ activeChannel.name }}</h2>
        <img src="/icons/global/keyboard_arrow_down.svg" alt="" />
      </div>

      <div class="channel-members">
        <div class="member-avatars">
          <ng-container *ngFor="let u of channelMembers | slice: 0: 3">
            <img
              class="member-avatar"
              [src]="getAvatarSrc(u)"
              [alt]="u.displayName || u.name || 'User'"
            />
          </ng-container>
        </div>

        <span>{{ channelMembers.length }}</span>

        <img
          class="add-person"
          src="/icons/global/person_add1.svg"
          alt=""
        />
      </div>
    </header>

    <div id="chat-container">
      <div class="messages-scroll" *ngIf="messages$ | async as msgs">
        <ng-container *ngIf="msgs.length === 0; else hasChannelMessages">
          <div class="empty-channel-wrapper">
            <div class="empty-channel-info">
              <span class="fw-700 fs-24"># {{ activeChannel.name }}</span>

              <p *ngIf="isChannelCreatedToday; else channelIntroDefault">
                Du hast diesen Channel heute erstellt. Das ist der Anfang des
                Channels
                <span class="channel-link"># {{ activeChannel.name }}</span>.
              </p>

              <ng-template #channelIntroDefault>
                <p>
                  Das ist der Anfang des Channels
                  <span class="channel-link"># {{ activeChannel.name }}</span>.
                </p>
              </ng-template>
            </div>
          </div>
        </ng-container>

        <ng-template #hasChannelMessages>
          <app-message
            [channel]="activeChannel"
            [currentUserUid]="currentUserUid"
            [messages]="msgs"
            [users]="users"
            [contextType]="'channel'"
            (editRequested)="onEditRequested($event)"
          ></app-message>
        </ng-template>
      </div>

      <app-message-input
        [channel]="activeChannel"
        [currentUserUid]="currentUserUid"
        [editingMessage]="editingMessage"
        (editFinished)="onEditFinished()"
      ></app-message-input>
    </div>
  </ng-container>

  <!-- NICHT-CHANNEL VIEW -->
  <ng-template #notChannelView>
    <!-- DM VIEW -->
    <ng-container
      *ngIf="
        viewMode === 'dm' &&
        selectedDmUserResolved as dmUser;
        else newMessageView
      "
    >
      <header class="dm-header">
        <div class="dm-header-left">
          <div>
            <img
              class="dm-header-avatar"
              [src]="getAvatarSrc(dmUser)"
              [alt]="dmUser.displayName || dmUser.name || 'User'"
            />
            <img
              class="online-icon"
              [src]="userService.getOnlineStatusIcon(dmUser)"
              alt=""
            />
          </div>
          <span class="dm-header-name fw-700 fs-24">
            {{ dmUser.displayName || dmUser.name || 'Unbekannter Nutzer' }}
          </span>
        </div>
      </header>

      <div class="dm-body" *ngIf="messages$ | async as msgs">
        <!-- vorhandene Nachrichten -->
        <div class="dm-messages" *ngIf="msgs.length > 0">
          <app-message
            [currentUserUid]="currentUserUid"
            [messages]="msgs"
            [users]="users"
            [contextType]="'conversation'"
            [conversationId]="currentConversationId"
            (editRequested)="onEditRequested($event)"
          ></app-message>
        </div>

        <!-- Intro nur, wenn noch keine Nachrichten -->
        <div class="dm-intro" *ngIf="msgs.length === 0">
          <div>
            <img
              class="dm-intro-avatar"
              [src]="getAvatarSrc(dmUser)"
              [alt]="dmUser.displayName || dmUser.name || 'User'"
            />
            <h2>
              {{ dmUser.displayName || dmUser.name || 'Unbekannter Nutzer' }}
            </h2>
          </div>
          <p>
            Diese Unterhaltung findet nur zwischen
            <span class="dm-mention"
              >@{{ dmUser.displayName || dmUser.name }}</span
            >
            und dir statt.
          </p>
        </div>
      </div>

      <app-message-input
        [currentUserUid]="currentUserUid"
        [contextType]="'conversation'"
        [conversationId]="currentConversationId"
        [editingMessage]="editingMessage"
        (editFinished)="onEditFinished()"
      ></app-message-input>
    </ng-container>

    <!-- NEW MESSAGE VIEW -->
    <ng-template #newMessageView>
      <section class="new-message-view">
        <header class="new-message-header">
          <h2>Neue Nachricht</h2>
        </header>

        <div class="recipient-input-wrapper">
          <input
            type="text"
            class="recipient-input"
            placeholder="An: #channel oder @jemand oder E-Mail Adresse"
            [value]="recipientInputValue"
            (input)="onRecipientInput($event)"
          />

          <div
            class="recipient-suggestions"
            *ngIf="showRecipientSuggestions"
          >
            <div
              class="recipient-suggestion"
              *ngFor="let s of recipientSuggestions"
              (click)="onSelectRecipient(s)"
            >
              <span class="suggestion-prefix">
                {{
                  s.type === 'channel'
                    ? '#'
                    : s.type === 'user'
                    ? '@'
                    : ''
                }}
              </span>

              <div class="suggestion-texts">
                <span class="suggestion-label">{{ s.label }}</span>
                <span class="suggestion-detail" *ngIf="s.detail">
                  {{ s.detail }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="new-message-body"></div>

        <app-message-input
          [currentUserUid]="currentUserUid"
          [contextType]="
            selectedRecipient?.type === 'channel'
              ? 'channel'
              : 'conversation'
          "
          [channel]="getSelectedRecipientChannel()"
          [conversationId]="
            selectedRecipient?.type === 'user'
              ? selectedRecipient?.id
              : undefined
          "
          (messageSent)="onNewMessageSent($event)"
        ></app-message-input>
      </section>
    </ng-template>
  </ng-template>
</section>
