<section>

  <header class="dm-header" [class.dm-header-small]="viewState.isChannel() || viewState.isDm()"
    [class.dm-header-big]="viewState.isNew()">
    <div id="header-left">

      @if (viewState.isChannel() && channel; as ch) {
      <img src="assets/icons/global/tag.svg" alt="">
      <div class="channel-name-wrapper">
        <span class="channel-name-text">{{ ch.name }}</span>
      </div>
      <img src="assets/icons/global/keyboard_arrow_down.svg" alt="" (click)="openChannelInfo()" style="cursor: pointer;">
      }

        @else if (viewState.isDm()) {
        @if (dmPartner) {
        <div style="position: relative; display: flex;">
          <img style="height: 50px; aspect-ratio: 1/1; border-radius: 50%;" [src]="getAvatarSrc(dmPartner)"
            [alt]="dmPartner.displayName || dmPartner.name || 'User'" />
          <img style="position: absolute; bottom: 5px; right: -5px; height: 17px;"
            [src]="userService.getOnlineStatusIcon(dmPartner)" alt="" />
        </div>
        <h2>{{ dmPartner.displayName || dmPartner.name || 'Unbekannter Nutzer' }}</h2>
        } @else {
        <h2>Direktnachricht</h2> 
        }
        }

        @else {
        <div
          style="display: flex; flex-direction: column; gap: 16px; align-items: start; width: 100%; position: relative;">
          <h2>Neue Nachricht</h2>

          <input class="new-message-to-input" type="text" [value]="newMessage.query()"
            (keyup)="onNewMessageToKeyup($event)" placeholder="An: #channel, oder @jemand oder E-Mail Adresse" />

          @if (newMessage.show() && newMessage.mode() === 'channel') {
          <div class="to-autocomplete">
            <div class="to-autocomplete-inner">
              @for (ch of newMessage.filteredChannels(); track ch.id ?? $index) {
              <div class="to-item" (click)="newMessage.selectChannel(ch)">
                <span class="to-hash">#</span>
                <div class="channel-info">
                  <span class="channel-name">{{ ch.name }}</span>
                  @if (ch.description) {
                  <span class="channel-description">{{ ch.description }}</span>
                  }
                </div>
              </div>
              }
            </div>
          </div>
          }

          @if (newMessage.show() && newMessage.mode() === 'user') {
          <div class="to-autocomplete">
            <div class="to-autocomplete-inner">
              @for (u of newMessage.filteredUsers(); track u.uid ?? $index) {
              <div class="to-item" (click)="newMessage.selectUser(u)">
                <div class="user-avatar-container">
                  <img [src]="getAvatarSrc(u)" [alt]="u.displayName || u.name" class="user-avatar">
                  <img [src]="userService.getOnlineStatusIcon(u)" class="online-status-icon">
                </div>
                <div class="user-info-container">
                  <span class="user-name">{{ u.displayName || u.name || 'Unbekannter Nutzer' }}</span>
                  @if (shouldShowEmail(u)) {
                  <span class="user-email">{{ u.email }}</span>
                  }
                </div>
              </div>
              }
            </div>
          </div>
          }
        </div>
        }

      </div>

    @if (viewState.isChannel() && channel) {
    <div class="channel-members">
      <div class="member-avatars" (click)="toggleChannelMemberList()">
        @for (u of channelMembers | slice:0:3; track u.uid ?? $index) {
        <img class="member-avatar" [src]="getAvatarSrc(u)" [alt]="u.displayName || u.name || 'User'" />
        }
        <span class="fw-600">{{ channelMembers.length }}</span>
      </div>

      <img class="add-person" 
           [src]="isHoveringAddPerson ? 'assets/icons/global/person_add2.svg' : 'assets/icons/global/person_add1.svg'"
           (mouseenter)="isHoveringAddPerson = true"
           (mouseleave)="isHoveringAddPerson = false"
           (click)="toggleAddChannelMemberPopup()">
      @if (showChannelMemberList()) {
      <div class="member-list-popup">
        <div class="member-list-content">
          <img src="assets/icons/global/close.svg" class="close-icon" (click)="toggleChannelMemberList()">
          <span class="fw-700 fs-24">Mitglieder</span>
          <div class="member-list">
            @for (m of channelMembers; track $index) {
            <div class="member" (click)="openProfile(m.id!)">
              <div>
                <img [src]="getAvatarSrc(m)" class="user-icon">
                <img [src]="userService.getOnlineStatusIcon(m)" class="status-icon">
              </div>
              <span class="fs-18">{{ m.displayName }}</span>
            </div>
            }

          </div>
          <div class="member">
            <div>
              <img src="assets/icons/global/person_add1.svg">
            </div>
            <span (click)="openAddingPopupFromMemberList()">Mitglieder hinzufügen</span>
          </div>
        </div>
      </div>
      }
      @if (showAddChannelMemberPopup()) {
      <app-add-member-popup [channel]="channel" (closed)="toggleAddChannelMemberPopup()"></app-add-member-popup>
      }

    </div>
    }
  </header>

  <div id="chat-container-new">

    <div class="messages-scroll" [ngClass]="{
        'justify-content-end':
          (viewState.isChannel() && (channelMessages?.length ?? 0) === 0) ||
          (viewState.isDm() && dmLoaded() && (dmMessages?.length ?? 0) === 0)
      }">

      @if (viewState.isChannel() && channel) {
      <app-message [channel]="channel" [currentUserUid]="currentUserUid" (editRequested)="onEditRequested($event)"
        (threadRequested)="onThreadRequested($event)">
      </app-message>
      }

      @else if (viewState.isDm()) {

      @if (!dmLoaded()) {
      }

      @else if ((dmMessages?.length ?? 0) === 0) {
      @if (dmPartner) {
      <div class="dm-intro">
        <div>
          <img class="dm-intro-avatar" [src]="getAvatarSrc(dmPartner)"
            [alt]="dmPartner.displayName || dmPartner.name || 'User'" />
          <h2>{{ dmPartner.displayName || dmPartner.name || 'Unbekannter Nutzer' }}</h2>
        </div>

        @if (isSelfChat()) {
        <p>
          <strong>Dieser Raum ist nur für dich da.</strong> Mache dir Notizen, liste deine To-dos auf oder bewahre Links und Dateien griffbereit auf. Du kannst hier auch gerne Dinge mit dir selbst besprechen.
        </p>
        } @else {
        <p>
          Diese Unterhaltung findet nur zwischen
          <span class="dm-mention">
            @{{ dmPartner.displayName || dmPartner.name }}
          </span>
          und dir statt.
        </p>
        }
      </div>
      }
      }

      @else {
      <app-message [contextType]="'conversation'" [conversationId]="dmConversationId" [currentUserUid]="currentUserUid"
        (editRequested)="onEditRequested($event)" (threadRequested)="onThreadRequested($event)">
      </app-message>
      }
      }

      @else {
      }
    </div>

    <app-message-input [currentUserUid]="currentUserUid" [forceEditable]="viewState.isNew()"
      [contextType]="viewState.isChannel() ? 'channel' : 'conversation'"
      [channel]="viewState.isChannel() ? (channel ?? undefined) : undefined"
      [conversationId]="viewState.isDm() ? dmConversationId : null" [editingMessage]="editingMessage ?? undefined"
      (editFinished)="onEditFinished()" [placeholderText]="
        viewState.isChannel()
          ? ('Nachricht an ' + (channel?.name ?? ''))
          : (viewState.isDm() ? 'Antwort' : 'Starte eine neue Nachricht')
      ">
    </app-message-input>

  </div>
</section>