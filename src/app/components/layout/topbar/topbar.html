<section class="header">
    <div class="top-bar">
        <div class="topbar">
            @if ((isNewMessageMode || showMobileBack) && isMobile()) {
            <div class="topbar-resp-btn-logo-container df cp" (click)="back.emit()">
                <img src="/assets/icons/global/keyboard_arrow_down.svg" class="back-btn">

                <div class="logo-title-container">
                    <img src="/assets/icons/global/workspace_logo.svg" />
                    <span>Devspace</span>
                </div>
            </div>
            }@else {
            <img src="/assets/icons/global/logo-header.svg" alt="logo">
            }
        </div>
        <div class="search-bar">
            <input type="text" id="name" name="name" placeholder="Devspace durchsuchen" class="search-inputs"
                [(ngModel)]="searchQuery" (input)="onSearchInput()" (focus)="onSearchFocus()" (blur)="onSearchBlur()">
            <img *ngIf="searchQuery.length > 0" src="/assets/icons/global/close.svg" alt="clear"
                class="search-icon-clear" (click)="clearSearch()">
            <img src="/assets/icons/global/search.svg" alt="search" class="search-icon-right">

            <!-- ========== USER SUGGESTIONS (mit @) ========== -->
            <div class="search-results" *ngIf="showUserSuggestions() && filteredUsers().length > 0">
                <div class="search-results-inner">
                    <div class="search-result-item" *ngFor="let user of filteredUsers()" (click)="selectUser(user)">
                        <div class="user-avatar-container">
                            <img [src]="getAvatarSrc(user)" [alt]="user.displayName || user.name" class="user-avatar">
                            <img [src]="userService.getOnlineStatusIcon(user)" class="online-status-icon">
                        </div>
                        <div class="user-info">
                            <span class="user-name">{{ user.displayName || user.name || 'Unbekannter Nutzer' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== CHANNEL SUGGESTIONS (mit #) ========== -->
            <div class="search-results" *ngIf="showChannelSuggestions() && filteredChannels().length > 0">
                <div class="search-results-inner">
                    <div class="search-result-item channel-item" *ngFor="let channel of filteredChannels()" (click)="selectChannel(channel)">
                        <img src="/assets/icons/global/tag.svg" alt="channel" class="channel-icon">
                        <div class="channel-info">
                            <span class="channel-name"># {{ channel.name }}</span>
                            <span class="channel-description" *ngIf="channel.description">{{ channel.description }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== NO RESULTS ========== -->
            <div class="search-results" *ngIf="(showUserSuggestions() && filteredUsers().length === 0) || (showChannelSuggestions() && filteredChannels().length === 0)">
                <div class="search-results-inner">
                    <div class="no-results">
                        <span *ngIf="showUserSuggestions()">Keine Benutzer gefunden</span>
                        <span *ngIf="showChannelSuggestions()">Keine Channels gefunden</span>
                    </div>
                </div>
            </div>

        </div>
        <div class="profil" (click)="toggleDropdownMenu($event)">
            <!-- ========== displayName hat Priorität (normalerweise Vor- und Nachname) ========== -->
            <h1>{{ currentUser()?.name || currentUser()?.displayName || 'Gast' }}</h1>
            <!-- ========== END ========== -->
            <div class="profil-image">
                <!-- ========== GEÄNDERT: Echter Avatar ========== -->
                <img [src]="getCurrentUserAvatar()" alt="avatar-profil">
                <img [src]="getCurrentUserOnlineStatus()" alt="avatar-online-icon" class="online-icon">
                <!-- ========== END GEÄNDERT ========== -->
            </div>
            <img src="/assets/icons/global/keyboard_arrow_down.svg" (click)="toggleDropdownMenu($event)"
                alt="arrow-drop-down">

            <div class="dropdown-menu" [class.show]="isDropdownMenuOpen">
                <div class="menu-name" [class.active]="activeProfilName === 'profil' && MobileProfil"
                    (click)="openProfilModal()">
                    <img src="/assets/icons/global/account_circle.svg" alt="profil" class="menu-icon">
                    Profil
                </div>
                <div class="menu-name" (click)="onLogout($event)">
                    <img src="/assets/icons/global/logout.svg" alt="profil" class="menu-icon">
                    Log out
                </div>
            </div>

            <div class="profil-modal" [class.show]="isProfilModalOpen" (click)="$event.stopPropagation()">
                <div class="modal-header">
                    <h2>Profil</h2>
                    <div class="close-icon-wrapper" (click)="closeProfilModal()">
                        <img src="/assets/icons/global/close.svg" alt="close" class="close-icon">
                    </div>
                </div>

                <div class="modal-content">
                    <div class="avatar-large">
                        <!-- ========== GEÄNDERT: Echter Avatar ========== -->
                        <img [src]="getCurrentUserAvatar()" alt="avatar-profil">
                        <!-- ========== END GEÄNDERT ========== -->
                    </div>

                    <div class="profil-info">
                        <div class="profil-info-details">
                            <!-- ========== GEÄNDERT: Echter Name ========== -->
                            <h3>{{ currentUser()?.displayName || currentUser()?.name || 'Gast' }}</h3>
                            <!-- ========== END GEÄNDERT ========== -->
                            <button class="edit-button" (click)="openProfilEditModal()">Bearbeiten</button>
                            <div class="testos activee" (click)="openProfilEditModal()">
                                <img src="/assets/icons/global/edit-profil-mobil.svg" alt="open-edit-profil">
                            </div>
                        </div>

                        <div class="status">
                            <span class="status-dot"></span>
                            <span class="status-text">Aktive</span>
                        </div>
                    </div>

                    <div class="email-section">
                        <img src="/assets/icons/login/mail_active.svg" alt="email" class="email-icon">
                        <div class="email-info">
                            <p class="email-label">E-Mail-Adresse</p>
                            <!-- ========== GEÄNDERT: Echte Email ========== -->
                            <p class="email-address">{{ currentUser()?.email || 'Keine E-Mail' }}</p>
                            <!-- ========== END GEÄNDERT ========== -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="profil-edit-modal" [class.show]="isProfilEditModalOpen" (click)="$event.stopPropagation()">
                <div class="modal-header">
                    <h2>Dein Profil bearbeiten</h2>
                    <div class="close-icon-wrapper" (click)="closeProfilEditModal()">
                        <img src="/assets/icons/global/close.svg" alt="close" class="close-icon">
                    </div>
                </div>

                <div class="modal-content">
                    <div class="avatar-large">
                        <!-- ========== GEÄNDERT: Echter Avatar ========== -->
                        <img [src]="getCurrentUserAvatar()" alt="avatar-profil">
                        <!-- ========== END GEÄNDERT ========== -->
                    </div>

                    <div class="form-section">
                        <div class="circle-profil-name">
                            <img class="" src="/assets/icons/global/account_circle.svg" alt="">
                            <label>Vollständiger Name</label>
                        </div>
                        <!-- ========== GEÄNDERT: Echter Name als Value ========== -->
                        <input type="text" [value]="currentUser()?.displayName || currentUser()?.name || ''" class="input-field">
                        <!-- ========== END GEÄNDERT ========== -->
                    </div>

                    <div class="modal-actions">
                        <button class="cancel-btn" (click)="closeProfilEditModal()">Abbrechen</button>
                        <button class="save-btn">Speichern</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="profil-modal-overlay" [class.show]="isProfilModalOpen" (click)="closeProfilModalOnly()"></div>

<div class="profil-modal-overlay" [class.show]="isProfilEditModalOpen" (click)="closeProfilEditModalOnly()"></div>