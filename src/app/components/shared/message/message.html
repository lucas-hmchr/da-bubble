<div class="message-container">
  <ng-container *ngIf="messages$ | async as msgs">
    <div *ngIf="msgs.length === 0" class="empty-channel-info">
      <span class="fw-700 fs-24"># {{ channel?.name }}</span>
      <p>Sei der Erste, der eine Nachricht in diesem Channel schreibt!</p>
    </div>

    <section *ngFor="let msg of msgs; let i = index" class="message-wrapper">
      <div class="date-separator" *ngIf="i === 0 || !isSameDay(msg.createdAt, msgs[i - 1]?.createdAt)">
        <span>
          {{ toDate(msg.createdAt) | date: 'EEEE, d. MMMM' }}
        </span>
      </div>

      <!-- WICHTIG: mouseleave bleibt, aber das Options-Menü setzt einen "hover lock" -->
      <div class="message-content" [class.menu-open]="!!msg.id && optionsMenuForMessageId === msg.id"
        [ngClass]="{ fdrr: isOwnMessage(msg) }" (mouseleave)="onMessageMouseLeave(msg)">
        <div class="message-actions">
          <img src="/assets/icons/global/check1.svg" alt="" class="action-btn check-btn"
            (click)="toggleReaction(msg, 'check')" />
          <img src="/assets/icons/global/thumbsup1.svg" alt="" class="action-btn thumbsup-btn"
            (click)="toggleReaction(msg, 'thumbsup')" />

          <img src="/assets/icons/global/reaction1.svg" alt="" class="action-btn reaction-btn"
            (click)="onToggleReactionPicker(msg)" />

          <img *ngIf="contextType === 'channel'" src="/assets/icons/global/answer1.svg" alt=""
            class="action-btn answer-btn" />

          <!-- 3-Punkte nur bei eigener Message -->
          <button *ngIf="isOwnMessage(msg)" type="button" class="action-btn option-btn"
            (click)="msg.id && toggleOptionsMenu($event, msg.id)">
            <img src="/assets/icons/global/option1.svg" alt="Optionen" />
          </button>

          <!-- Options-Menü: nur wenn msg.id existiert UND dieses Menü offen ist -->
          <div class="message-options-menu" *ngIf="isOwnMessage(msg) && !!msg.id && optionsMenuForMessageId === msg.id"
            [class.open-up]="optionsMenuOpenUp" (mouseenter)="onOptionsMenuMouseEnter()"
            (mouseleave)="onOptionsMenuMouseLeave()" (click)="$event.stopPropagation()">
            <button class="menu-item" type="button" (click)="onEditMessage(msg); closeOptionsMenu()">
              Nachricht bearbeiten
            </button>

            <button class="menu-item" type="button" (click)="onDeleteMessage(msg); closeOptionsMenu()">
              Nachricht löschen
            </button>
          </div>
        </div>

        <div class="reaction-picker" *ngIf="reactionPickerForMessageId === msg.id">
          <button class="reaction-emoji-btn" *ngFor="let r of emojiReactions" (click)="onEmojiReaction(msg, r.id)">
            {{ r.icon }}
          </button>
        </div>

        <img class="profile-pic" [src]="getSenderAvatarUrl(msg.senderId)" [alt]="getSenderName(msg.senderId)" />

        <div>
          <div>
            <span class="send-name">
              {{ getSenderName(msg.senderId) }}
            </span>
            <span class="send-info">
              {{ toDate(msg.createdAt) | date: 'HH:mm' }} Uhr
            </span>
          </div>

          <p class="text bubble" [ngClass]="isOwnMessage(msg) ? 'me-person' : 'other-person'">
            {{ msg.text }}
          </p>

          <div class="reactions-summary" *ngIf="msg.reactions && hasReactions(msg)">
            <button class="reaction-chip" *ngFor="let rid of getReactionIds(msg)" [ngClass]="{
                'mine': hasCurrentUserReaction(msg, rid),
                'own-message': isOwnMessage(msg)
              }" (click)="toggleReaction(msg, rid)" (mouseenter)="msg.id && onHoverReaction(msg.id, rid)"
              (mouseleave)="onLeaveReaction()">
              <ng-container *ngIf="getReactionDefById(rid) as def">
                <img *ngIf="!def.isEmoji" [src]="def.icon" alt="" class="reaction-icon" />
                <span *ngIf="def.isEmoji" class="reaction-emoji">
                  {{ def.icon }}
                </span>
              </ng-container>

              <span class="reaction-count">{{ getReactionCount(msg, rid) }}</span>

              <div class="reaction-tooltip" *ngIf="hoveredReaction === rid && hoveredMessageId === msg.id">
                <div class="tooltip-icon" *ngIf="getReactionDefById(rid) as def">
                  <img *ngIf="!def.isEmoji" [src]="def.icon" alt="" />
                  <span *ngIf="def.isEmoji">
                    {{ def.icon }}
                  </span>
                </div>

                <div class="tooltip-name">
                  {{ getReactionUserLabel(msg, rid) }}
                </div>
                <div class="tooltip-text">
                  hat reagiert
                </div>
              </div>
            </button>
          </div>

          <div *ngIf="msg.threadCount > 0">
            <a href="javascript:void(0)">
              {{ msg.threadCount }} Antworten
            </a>
          </div>
        </div>
      </div>
    </section>

    <div #bottom></div>
  </ng-container>
</div>