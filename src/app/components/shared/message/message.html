<div class="message-container">
  <ng-container *ngIf="messages$ | async as msgs">
    <div *ngIf="msgs.length === 0" class="empty-channel-info">
      <span class="fw-700 fs-24"># {{ channel?.name }}</span>
      <p>Sei der Erste, der eine Nachricht in diesem Channel schreibt!</p>
    </div>

    <section *ngFor="let msg of msgs; let i = index" class="message-wrapper"
      [class.menu-open]="optionsMenuForMessageId === msg.id">
      <div class="date-separator" *ngIf="i === 0 || !isSameDay(msg.createdAt, msgs[i - 1]?.createdAt)">
        <span>
          {{ getFormattedDateWithWeekday(msg.createdAt) }}
        </span>
      </div>

      <div class="message-content" [ngClass]="{ fdrr: isOwnMessage(msg) }" (mouseleave)="onMessageMouseLeave(msg)">
        <div class="message-actions">
          <button class="emoji-quick-btn" (click)="toggleReaction(msg, 'check')">
            ‚úÖ
          </button>
          <button class="emoji-quick-btn" (click)="toggleReaction(msg, 'thumbsup')">
            üëç
          </button>

          <img src="/assets/icons/global/reaction1.svg" alt="" class="action-btn reaction-btn"
            (click)="onToggleReactionPicker(msg)" />

          <img *ngIf="contextType === 'channel'" src="/assets/icons/global/answer1.svg" alt="Thread √∂ffnen"
            class="action-btn answer-btn" (click)="onOpenThread(msg)" />

          <button *ngIf="isOwnMessage(msg)" class="action-btn option-btn"
            (click)="msg.id && toggleOptionsMenu($event, msg.id)" type="button">
            <img src="/assets/icons/global/option1.svg" alt="">
          </button>

          @if (optionsMenuForMessageId === msg.id) {
          <div class="message-options-menu" [class.open-up]="optionsMenuOpenUp" (mouseenter)="onOptionsMenuMouseEnter()"
            (mouseleave)="onOptionsMenuMouseLeave()" (click)="$event.stopPropagation()">
            <button class="menu-item" type="button" (click)="startInlineEdit(msg); closeOptionsMenu()">
              Nachricht bearbeiten
            </button>
            <button class="menu-item" type="button" (click)="onDeleteMessage(msg); closeOptionsMenu()">
              Nachricht l√∂schen
            </button>
          </div>
          }
        </div>

        <div class="reaction-picker" *ngIf="reactionPickerForMessageId === msg.id">
          <button class="reaction-emoji-btn" *ngFor="let r of emojiReactions" (click)="onEmojiReaction(msg, r.id)">
            {{ r.icon }}
          </button>
        </div>


        <img class="profile-pic" 
     [src]="getSenderAvatarUrl(msg.senderId)" 
     [alt]="getSenderName(msg.senderId)"
     (click)="openUserProfile(msg.senderId, $event)"
     style="cursor: pointer;" />

        <div>
          <div [class.message-header-reverse]="isOwnMessage(msg)">
            <span class="send-name clickable" (click)="openUserProfile(msg.senderId, $event)">
              {{ getSenderName(msg.senderId) }}
            </span>
            <span class="send-info">
              <ng-container *ngIf="showFullDate">
                {{ getFormattedDate(msg.createdAt) }}
              </ng-container>
              {{ toDate(msg.createdAt) | date: 'HH:mm' }} Uhr
            </span>
          </div>

          <ng-container *ngIf="editingMessageId === msg.id; else normalBubble">
            <div class="inline-edit fdc" (click)="$event.stopPropagation()">
              <textarea class="inline-edit-textarea" [attr.data-edit-id]="msg.id" [(ngModel)]="editText"
                (keydown)="onInlineEditKeydown($event, msg)"></textarea>

              <div class="inline-edit-actions">
                <button type="button" class="inline-edit-cancel" (click)="cancelInlineEdit()">Abbrechen</button>
                <button type="button" class="inline-edit-save" [disabled]="!canSaveInlineEdit"
                  (click)="saveInlineEdit(msg)">
                  Speichern
                </button>
              </div>
            </div>
          </ng-container>


          <ng-template #normalBubble>
            <p class="text bubble" [ngClass]="isOwnMessage(msg) ? 'me-person' : 'other-person'">
              {{ msg.text }}
            </p>
          </ng-template>

          <div class="reactions-summary" *ngIf="msg.reactions && hasReactions(msg)">
            <button class="reaction-chip" *ngFor="let rid of getReactionIds(msg)" [ngClass]="{
                'mine': hasCurrentUserReaction(msg, rid),
                'own-message': isOwnMessage(msg)
              }" (click)="toggleReaction(msg, rid)" (mouseenter)="msg.id && onHoverReaction(msg.id, rid)"
              (mouseleave)="onLeaveReaction()">
              <ng-container *ngIf="getReactionDefById(rid) as def">
                <img *ngIf="!def.isEmoji" [src]="def.icon" alt="" class="reaction-icon" />
                <span *ngIf="def.isEmoji" class="reaction-emoji">
                  {{ def.icon }}
                </span>
              </ng-container>

              <span class="reaction-count">{{ getReactionCount(msg, rid) }}</span>

              <div class="reaction-tooltip" *ngIf="hoveredReaction === rid && hoveredMessageId === msg.id">
                <div class="tooltip-icon" *ngIf="getReactionDefById(rid) as def">
                  <img *ngIf="!def.isEmoji" [src]="def.icon" alt="" />
                  <span *ngIf="def.isEmoji">
                    {{ def.icon }}
                  </span>
                </div>

                <div class="tooltip-name">
                  {{ getReactionUserLabel(msg, rid) }}
                </div>
                <div class="tooltip-text">
                  hat reagiert
                </div>
              </div>
            </button>
          </div>

          <div *ngIf="msg.threadCount > 0" class="thread-replies">
            <a href="javascript:void(0)" (click)="onOpenThread(msg)" class="thread-link">
              {{ msg.threadCount }} {{ msg.threadCount === 1 ? 'Antwort' : 'Antworten' }}
            </a>
            <span class="last-reply-time" *ngIf="msg.lastReplyAt">
              Letzte Antwort: {{ toDate(msg.lastReplyAt) | date: 'HH:mm' }} Uhr
            </span>
          </div>
        </div>
      </div>
    </section>

    <div #bottom></div>
  </ng-container>
</div>
<!-- <app-profile-popup></app-profile-popup> -->