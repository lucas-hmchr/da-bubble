<div class="message-container">
  <ng-container *ngIf="messages$ | async as msgs">
    <div *ngIf="msgs.length === 0" class="empty-channel-info">
      <span class="fw-700 fs-24"># {{ channel?.name }}</span>
      <p>Sei der Erste, der eine Nachricht in diesem Channel schreibt!</p>
    </div>

    <section *ngFor="let msg of msgs; let i = index; trackBy: trackByMessageId" class="message-wrapper" [attr.data-message-id]="msg.id"
      [class.menu-open]="optionsMenuForMessageId === getUniqueMessageId(msg)">
      <div class="date-separator" *ngIf="i === 0 || !formatter.isSameDay(msg.createdAt, msgs[i - 1]?.createdAt)">
        <span>
          {{ formatter.getFormattedDateWithWeekday(msg.createdAt) }}
        </span>
      </div>

      <div class="message-content" [ngClass]="{ fdrr: helper.isOwnMessage(msg.senderId, currentUserUid) }" (mouseleave)="onMessageMouseLeave(msg)">
        <div class="message-actions">
          <button type="button" class="emoji-quick-btn" *ngFor="let emojiId of getQuickEmojis()"
            (click)="toggleReaction(msg, emojiId)">
            <ng-container *ngIf="getReactionDef(emojiId) as def">
              <span>{{ def.icon }}</span>
            </ng-container>
          </button>

          <img [src]="isHoveringReaction ? './assets/icons/global/reaction2.svg' : './assets/icons/global/reaction1.svg'" 
               alt="" 
               class="action-btn reaction-btn"
               (mouseenter)="isHoveringReaction = true"
               (mouseleave)="isHoveringReaction = false"
               (click)="onToggleReactionPicker(msg)" />

          <img *ngIf="contextType === 'channel'" 
               [src]="isHoveringThread ? './assets/icons/global/answer2.svg' : './assets/icons/global/answer1.svg'"
               alt="Thread öffnen"
               class="action-btn answer-btn"
               (mouseenter)="isHoveringThread = true"
               (mouseleave)="isHoveringThread = false"
               (click)="onOpenThread(msg)" />

          <button *ngIf="helper.isOwnMessage(msg.senderId, currentUserUid)" 
                  class="action-btn option-btn"
                  (click)="msg.id && toggleOptionsMenu($event, msg.id)" 
                  type="button"
                  (mouseenter)="isHoveringOptions = true"
                  (mouseleave)="isHoveringOptions = false">
            <img [src]="isHoveringOptions ? './assets/icons/global/option2.svg' : './assets/icons/global/option1.svg'" 
                 alt="">
          </button>

          @if (optionsMenuForMessageId === getUniqueMessageId(msg)) {
          <div class="message-options-menu" [class.open-up]="isLastMessage(msg, msgs)"
            (mouseenter)="onOptionsMenuMouseEnter()" (mouseleave)="onOptionsMenuMouseLeave()"
            (click)="$event.stopPropagation()">
            <button class="menu-item" type="button" (click)="startInlineEdit(msg); closeOptionsMenu()">
              Nachricht bearbeiten
            </button>
            <button class="menu-item" type="button" (click)="onDeleteMessage(msg); closeOptionsMenu()">
              Nachricht löschen
            </button>
          </div>
          }
        </div>

        <div class="reaction-picker-wrapper" [class.open-up]="isLastMessage(msg, msgs)"
          *ngIf="reactionPickerForMessageId === getUniqueMessageId(msg)">
          <div class="reaction-picker">
            <button class="reaction-emoji-btn" *ngFor="let r of emojiReactions" (click)="onEmojiReaction(msg, r.id)">
              {{ r.icon }}
            </button>
          </div>
        </div>


        <img class="profile-pic" [src]="helper.getSenderAvatarUrl(msg.senderId)" [alt]="helper.getUserDisplayName(msg.senderId)"
          (click)="openUserProfile(msg.senderId, $event)" style="cursor: pointer;" />

        <div>
          <div [class.message-header-reverse]="helper.isOwnMessage(msg.senderId, currentUserUid)" class="gap5">
            <span class="send-name clickable" (click)="openUserProfile(msg.senderId, $event)">
              {{ helper.getUserDisplayName(msg.senderId) }}
            </span>
            <span class="send-info">
              <ng-container *ngIf="showFullDate">
                {{ formatter.getFormattedDate(msg.createdAt) }}
              </ng-container>
              {{ formatter.toDate(msg.createdAt) | date: 'HH:mm' }} Uhr
            </span>
          </div>

          <ng-container *ngIf="editingMessageId === msg.id; else normalBubble">
            <div class="inline-edit fdc" (click)="$event.stopPropagation()">
              <textarea class="inline-edit-textarea" [attr.data-edit-id]="msg.id" [(ngModel)]="editText"
                (keydown)="onInlineEditKeydown($event, msg)"></textarea>

              <div class="inline-edit-actions">
                <button type="button" class="inline-edit-cancel" (click)="cancelInlineEdit()">Abbrechen</button>
                <button type="button" class="inline-edit-save" [disabled]="!canSaveInlineEdit"
                  (click)="saveInlineEdit(msg)">
                  Speichern
                </button>
              </div>
            </div>
          </ng-container>


          <ng-template #normalBubble>
            <p class="text bubble" [ngClass]="helper.isOwnMessage(msg.senderId, currentUserUid) ? 'me-person' : 'other-person'"
              [innerHTML]="users.length > 0 ? formatter.parseMessageText(msg.text, users) : msg.text"
              (click)="onMessageTextClick($event)">
            </p>
          </ng-template>

          <div class="reactions-summary" *ngIf="msg.reactions && reactionService.hasReactions(msg)">
            <button class="reaction-chip" *ngFor="let rid of getVisibleReactionIds(msg)" [ngClass]="{
                'mine': hasUserReacted(msg, rid),
                'own-message': helper.isOwnMessage(msg.senderId, currentUserUid)
              }" (click)="toggleReaction(msg, rid)" (mouseenter)="msg.id && onHoverReaction(msg.id, rid)"
              (mouseleave)="onLeaveReaction()">
              <ng-container *ngIf="getReactionDef(rid) as def">
                <img *ngIf="!def.isEmoji" [src]="def.icon" alt="" class="reaction-icon" />
                <span *ngIf="def.isEmoji" class="reaction-emoji">
                  {{ def.icon }}
                </span>
              </ng-container>

              <span class="reaction-count">{{ reactionService.getReactionCount(msg, rid) }}</span>

              <div class="reaction-tooltip" *ngIf="hoveredReaction === rid && hoveredMessageId === msg.id">
                <div class="tooltip-icon" *ngIf="getReactionDef(rid) as def">
                  <img *ngIf="!def.isEmoji" [src]="def.icon" alt="" />
                  <span *ngIf="def.isEmoji">
                    {{ def.icon }}
                  </span>
                </div>

                <div class="tooltip-name">
                  {{ getReactionUserLabel(msg, rid) }}
                </div>
                <div class="tooltip-text">
                  hat reagiert
                </div>
              </div>
            </button>

            <span class="remaining-reactions" *ngIf="getRemainingReactionsCount(msg) > 0">
              +{{ getRemainingReactionsCount(msg) }} weitere
            </span>
          </div>

          <div *ngIf="msg.threadCount > 0" class="thread-replies">
            <a href="javascript:void(0)" (click)="onOpenThread(msg)" class="thread-link">
              {{ msg.threadCount }} {{ msg.threadCount === 1 ? 'Antwort' : 'Antworten' }}
            </a>
            <span class="last-reply-time" *ngIf="msg.lastReplyAt">
              {{ formatter.toDate(msg.lastReplyAt) | date: 'HH:mm' }} Uhr
            </span>
          </div>
        </div>
      </div>
    </section>

    <div #bottom></div>
  </ng-container>
</div>