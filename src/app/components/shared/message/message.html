<div class="message-container">
  <ng-container *ngIf="messages$ | async as msgs">
    <div *ngIf="msgs.length === 0" class="empty-channel-info">
      <p>Sei der Erste, der eine Nachricht in diesem Channel schreibt!</p>
    </div>

    <section *ngFor="let msg of msgs; let i = index" class="message-wrapper">
      <div
        class="date-separator"
        *ngIf="i === 0 || !isSameDay(msg.createdAt, msgs[i - 1]?.createdAt)"
      >
        <span>
          {{ toDate(msg.createdAt) | date: 'EEEE, d. MMMM' }}
        </span>
      </div>

      <div class="message-content" [ngClass]="{ fdrr: isOwnMessage(msg) }"  (mouseleave)="onMessageMouseLeave(msg)">
        <!-- Hover-Menü -->
        <div class="message-actions">
          <img
            src="/icons/global/check1.svg"
            alt=""
            class="action-btn check-btn"
            (click)="toggleReaction(msg, 'check')"
          />
          <img
            src="/icons/global/thumbsup1.svg"
            alt=""
            class="action-btn thumbsup-btn"
            (click)="toggleReaction(msg, 'thumbsup')"
          />

          <!-- Reactions-Palette öffnen -->
          <img
            src="/icons/global/reaction1.svg"
            alt=""
            class="action-btn reaction-btn"
            (click)="onToggleReactionPicker(msg)"
          />

          <img
            src="/icons/global/answer1.svg"
            alt=""
            class="action-btn answer-btn"
          />

          <img
            *ngIf="isOwnMessage(msg)"
            src="/icons/global/option1.svg"
            alt=""
            class="action-btn option-btn"
            (click)="onEditMessage(msg)"
          />
        </div>

        <!-- Emoji-Reactions-Palette (unter dem Hover-Menü) -->
        <div
          class="reaction-picker"
          *ngIf="reactionPickerForMessageId === msg.id"
        >
          <button
            class="reaction-emoji-btn"
            *ngFor="let r of emojiReactions"
            (click)="onEmojiReaction(msg, r.id)"
          >
            {{ r.icon }}
          </button>
        </div>

        <img
          class="profile-pic"
          [src]="getSenderAvatarUrl(msg.senderId)"
          [alt]="getSenderName(msg.senderId)"
        />

        <div>
          <div>
            <span class="send-name">
              {{ getSenderName(msg.senderId) }}
            </span>
            <span class="send-info">
              {{ toDate(msg.createdAt) | date: 'HH:mm' }} Uhr
            </span>
          </div>

          <!-- Bubble -->
          <p
            class="text bubble"
            [ngClass]="isOwnMessage(msg) ? 'me-person' : 'other-person'"
          >
            {{ msg.text }}
          </p>

          <!-- Reactions-Übersicht unter der Message -->
          <div
            class="reactions-summary"
            *ngIf="msg.reactions && hasReactions(msg)"
          >
            <button
              class="reaction-chip"
              *ngFor="let rid of getReactionIds(msg)"
              [ngClass]="{
                'mine': hasCurrentUserReaction(msg, rid),
                'own-message': isOwnMessage(msg)
              }"
              (click)="toggleReaction(msg, rid)"
            >
              <ng-container *ngIf="getReactionDefById(rid) as def">
                <img
                  *ngIf="!def.isEmoji"
                  [src]="def.icon"
                  alt=""
                  class="reaction-icon"
                />
                <span *ngIf="def.isEmoji" class="reaction-emoji">
                  {{ def.icon }}
                </span>
              </ng-container>

              <span class="reaction-count">
                {{ getReactionCount(msg, rid) }}
              </span>
            </button>
          </div>

          <div *ngIf="msg.threadCount > 0">
            <a href="javascript:void(0)">
              {{ msg.threadCount }} Antworten
            </a>
          </div>
        </div>
      </div>
    </section>

    <div #bottom></div>
  </ng-container>
</div>
